<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flood Monitoring System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:#0f172a;
  color:white;
  text-align:center;
}

.header{
  padding:20px;
  background:#1e293b;
  box-shadow:0 0 20px black;
}

.grid{
  display:flex;
  justify-content:center;
  gap:40px;
  margin-top:30px;
  flex-wrap:wrap;
}

.card{
  background:#1e293b;
  padding:20px;
  border-radius:15px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
}

#riverBox{
  width:150px;
  height:350px;
  border:3px solid white;
  position:relative;
}

#water{
  position:absolute;
  bottom:0;
  width:100%;
  background:linear-gradient(to top,#2563eb,#60a5fa);
  height:0%;
  transition:0.5s;
}

.scale{
  position:absolute;
  left:-30px;
  color:white;
  font-size:12px;
}

.status{
  font-size:26px;
  padding:15px;
  border-radius:10px;
  font-weight:bold;
}

.safe{ background:#16a34a; box-shadow:0 0 20px #16a34a;}
.warning{ background:#facc15; color:black; box-shadow:0 0 20px #facc15;}
.danger{ background:#dc2626; animation:blink 1s infinite; box-shadow:0 0 20px red;}

@keyframes blink{
  50%{ opacity:0.5;}
}

.valueBig{
  font-size:40px;
  margin:10px 0;
}

canvas{
  max-width:900px;
  margin-top:40px;
}
</style>
</head>

<body>

<div class="header">
  <h1>ðŸŒŠ FLOOD MONITORING SYSTEM</h1>
  <h3 id="ipDisplay">Connecting...</h3>
</div>

<div class="grid">

  <div class="card">
    <h2>River Level</h2>
    <div id="riverBox">
      <div id="water"></div>

      <div class="scale" style="bottom:0%">0cm</div>
      <div class="scale" style="bottom:16%">1cm</div>
      <div class="scale" style="bottom:33%">2cm</div>
      <div class="scale" style="bottom:50%">3cm</div>
      <div class="scale" style="bottom:66%">4cm</div>
      <div class="scale" style="bottom:83%">5cm</div>
      <div class="scale" style="bottom:100%">6cm</div>
    </div>
    <div class="valueBig" id="waterValue">0 cm</div>
  </div>

  <div class="card">
    <h2>Status</h2>
    <div id="statusBox" class="status safe">AN TOAN</div>
    <h3>ADC: <span id="adcValue">0</span></h3>
  </div>

</div>

<canvas id="chart"></canvas>

<script>
const ESP_IP = "http://192.168.1.159/data";
document.getElementById("ipDisplay").innerText = ESP_IP;

let ctx = document.getElementById('chart').getContext('2d');

let chart = new Chart(ctx,{
    type:'line',
    data:{
        labels:[],
        datasets:[{
            label:'Water Level (cm)',
            data:[],
            borderColor:'#3b82f6',
            borderWidth:3,
            fill:false,
            tension:0.3
        }]
    },
    options:{
        responsive:true,
        scales:{
            y:{ min:0, max:6 }
        }
    }
});

function updateData(){

  fetch(ESP_IP)
  .then(res=>res.json())
  .then(data=>{

    let water = parseFloat(data.water_cm);
    let adc = data.adc;
    let status = data.status;

    document.getElementById("waterValue").innerText = water + " cm";
    document.getElementById("adcValue").innerText = adc;

    let percent = (water/6)*100;
    document.getElementById("water").style.height = percent + "%";

    let box = document.getElementById("statusBox");
    box.innerText = status;
    box.classList.remove("safe","warning","danger");

    if(status==="AN TOAN") box.classList.add("safe");
    if(status==="CANH BAO") box.classList.add("warning");
    if(status==="RAT NGUY HIEM") box.classList.add("danger");

    let time = new Date().toLocaleTimeString();

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(water);

    if(chart.data.labels.length>20){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    chart.update();
  })
  .catch(()=>{
    document.getElementById("statusBox").innerText="MAT KET NOI";
  });
}

setInterval(updateData,1000);
updateData();
</script>

</body>
</html>
