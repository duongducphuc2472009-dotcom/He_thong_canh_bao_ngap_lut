<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flood Monitoring System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:#0f172a;
  color:white;
  text-align:center;
}

.header{
  padding:20px;
  background:#1e293b;
}

.grid{
  display:flex;
  justify-content:center;
  gap:40px;
  margin-top:30px;
  flex-wrap:wrap;
}

.card{
  background:#1e293b;
  padding:20px;
  border-radius:15px;
}

#riverBox{
  width:150px;
  height:350px;
  border:3px solid white;
  position:relative;
}

#water{
  position:absolute;
  bottom:0;
  width:100%;
  background:linear-gradient(to top,#2563eb,#60a5fa);
  height:0%;
  transition:0.5s;
}

.status{
  font-size:26px;
  padding:15px;
  border-radius:10px;
  font-weight:bold;
}

.safe{background:#16a34a;}
.warning{background:#facc15;color:black;}
.danger{background:#dc2626;animation:blink 1s infinite;}

@keyframes blink{
  50%{opacity:0.5;}
}

.valueBig{
  font-size:40px;
  margin:10px 0;
}

canvas{
  max-width:900px;
  margin-top:40px;
}
</style>
</head>

<body>

<div class="header">
<h1>ðŸŒŠ FLOOD MONITORING SYSTEM</h1>
</div>

<div class="grid">

<div class="card">
<h2>River Level</h2>
<div id="riverBox">
<div id="water"></div>
</div>
<div class="valueBig" id="waterValue">0 cm</div>
</div>

<div class="card">
<h2>Status</h2>
<div id="statusBox" class="status safe">AN TOAN</div>
<h3>ADC: <span id="adcValue">0</span></h3>
</div>

</div>

<canvas id="chart"></canvas>

<script>

const TOKEN = "aDr0xW5cnhpazhuPPuIDUQWZGmtRtAhY";

// ==== BIá»‚U Äá»’ ====
let ctx = document.getElementById('chart').getContext('2d');

let chart = new Chart(ctx,{
  type:'line',
  data:{
    labels:[],
    datasets:[{
      label:'Water Level (cm)',
      data:[],
      borderColor:'#3b82f6',
      borderWidth:3,
      fill:false,
      tension:0.3
    }]
  },
  options:{
    responsive:true,
    scales:{
      y:{min:2,max:6}
    }
  }
});

// ==== FETCH DATA ====
async function updateData(){

  try{

    let adcRes = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V0`);
    let cmRes  = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V1`);
    let stRes  = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V2`);

    let adc = await adcRes.text();
    let cm  = await cmRes.text();
    let st  = await stRes.text();

    adc = parseInt(adc);
    cm  = parseFloat(cm);
    st  = parseInt(st);

    document.getElementById("adcValue").innerText = adc;
    document.getElementById("waterValue").innerText = cm.toFixed(2) + " cm";

    let percent = ((cm - 2) / 4) * 100;
    document.getElementById("water").style.height = percent + "%";

    let statusBox = document.getElementById("statusBox");
    statusBox.className = "status";

    if(st === 0){
      statusBox.innerText = "AN TOAN";
      statusBox.classList.add("safe");
    }
    else if(st === 1){
      statusBox.innerText = "CANH BAO";
      statusBox.classList.add("warning");
    }
    else{
      statusBox.innerText = "RAT NGUY HIEM";
      statusBox.classList.add("danger");
    }

    let time = new Date().toLocaleTimeString();

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(cm);

    if(chart.data.labels.length > 20){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    chart.update();

  }catch(error){
    console.log("Loi ket noi Blynk:", error);
  }
}

setInterval(updateData,1000);
updateData();

</script>

</body>
</html>
