<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>H·ªá th·ªëng c·∫£nh b√°o ng·∫≠p l·ª•t</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:#0f172a;
  color:white;
  text-align:center;
}

.header{
  padding:20px;
  background:#1e293b;
  font-size:28px;
  font-weight:bold;
}

.grid{
  display:flex;
  justify-content:center;
  gap:40px;
  margin-top:30px;
  flex-wrap:wrap;
}

.card{
  background:#1e293b;
  padding:20px;
  border-radius:15px;
  width:260px;
}

#riverBox{
  width:150px;
  height:350px;
  border:3px solid white;
  margin:auto;
  position:relative;
}

#water{
  position:absolute;
  bottom:0;
  width:100%;
  background:linear-gradient(to top,#2563eb,#60a5fa);
  height:0%;
  transition:0.5s;
}

.status{
  font-size:22px;
  padding:12px;
  border-radius:10px;
  font-weight:bold;
}

.safe{background:#16a34a;}
.warning{background:#facc15;color:black;}
.danger{background:#dc2626;animation:blink 1s infinite;}

@keyframes blink{
  50%{opacity:0.5;}
}

.valueBig{
  font-size:32px;
  margin:10px 0;
}

canvas{
  max-width:900px;
  margin-top:40px;
}
</style>
</head>

<body>

<div class="header">
üåä H·ªÜ TH·ªêNG C·∫¢NH B√ÅO NG·∫¨P L·ª§T
</div>

<div class="grid">

<div class="card">
<h2>M·ª±c n∆∞·ªõc</h2>
<div id="riverBox">
<div id="water"></div>
</div>
<div class="valueBig" id="waterValue">0 cm</div>
</div>

<div class="card">
<h2>Tr·∫°ng th√°i</h2>
<div id="statusBox" class="status safe">AN TO√ÄN</div>
<h3>Gi√° tr·ªã ADC: <span id="adcValue">0</span></h3>
</div>

</div>

<canvas id="chart"></canvas>

<script>

const TOKEN = "aDr0xW5cnhpazhuPPuIDUQWZGmtRtAhY";

// ===== BI·ªÇU ƒê·ªí =====
let ctx = document.getElementById('chart').getContext('2d');

let chart = new Chart(ctx,{
  type:'line',
  data:{
    labels:[],
    datasets:[{
      label:'M·ª±c n∆∞·ªõc (cm)',
      data:[],
      borderColor:'#3b82f6',
      borderWidth:3,
      fill:false,
      tension:0.3
    }]
  },
  options:{
    responsive:true,
    scales:{
      y:{min:2,max:6}
    }
  }
});

// ===== H√ÄM CHUY·ªÇN DATA BLYNK =====
function cleanValue(value){
  try{
    let parsed = JSON.parse(value);
    return parsed[0];
  }catch{
    return value;
  }
}

// ===== FETCH =====
async function updateData(){

  try{

    let adcRes = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V0`);
    let cmRes  = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V1`);
    let stRes  = await fetch(`https://blynk.cloud/external/api/get?token=${TOKEN}&V2`);

    let adc = cleanValue(await adcRes.text());
    let cm  = cleanValue(await cmRes.text());
    let st  = cleanValue(await stRes.text());

    adc = parseInt(adc);
    cm  = parseFloat(cm);
    st  = parseInt(st);

    document.getElementById("adcValue").innerText = adc;
    document.getElementById("waterValue").innerText = cm.toFixed(2) + " cm";

    // T√≠nh % n∆∞·ªõc
    let percent = ((cm - 2) / 4) * 100;
    percent = Math.max(0, Math.min(100, percent));
    document.getElementById("water").style.height = percent + "%";

    let statusBox = document.getElementById("statusBox");
    statusBox.className = "status";

    if(st === 0){
      statusBox.innerText = "AN TO√ÄN";
      statusBox.classList.add("safe");
    }
    else if(st === 1){
      statusBox.innerText = "C·∫¢NH B√ÅO";
      statusBox.classList.add("warning");
    }
    else{
      statusBox.innerText = "R·∫§T NGUY HI·ªÇM";
      statusBox.classList.add("danger");
    }

    let time = new Date().toLocaleTimeString();

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(cm);

    if(chart.data.labels.length > 20){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    chart.update();

  }catch(error){
    console.log("L·ªói k·∫øt n·ªëi Blynk:", error);
  }
}

setInterval(updateData,1000);
updateData();

</script>

</body>
</html>

