<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flood Environmental Monitoring Station</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(to bottom,#0f172a,#1e293b);
    color:white;
}

header{
    padding:20px;
    text-align:center;
    font-size:24px;
    font-weight:bold;
    background:#0f172a;
    border-bottom:1px solid #334155;
}

.container{
    display:grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap:20px;
    padding:20px;
}

.card{
    background:#1e293b;
    padding:20px;
    border-radius:12px;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
}

.big-number{
    font-size:42px;
    font-weight:bold;
}

.status{
    padding:8px 12px;
    border-radius:8px;
    display:inline-block;
    font-weight:bold;
}

.safe{ background:#22c55e; }
.warning{ background:#facc15; color:black; }
.danger{ background:#ef4444; }

canvas{
    background:#0f172a;
    border-radius:12px;
}

/* RIVER */
.river-box{
    position:relative;
    height:300px;
    background:linear-gradient(to bottom,#0ea5e9,#0369a1);
    border-radius:12px;
    overflow:hidden;
}

.water{
    position:absolute;
    bottom:0;
    width:100%;
    background:#38bdf8;
    transition:height 1s ease;
}

/* SCALE FIXED: tƒÉng d·∫ßn t·ª´ d∆∞·ªõi l√™n */
.scale{
    position:absolute;
    right:8px;
    top:0;
    height:100%;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    font-size:12px;
    font-weight:bold;
}

.log{
    max-height:150px;
    overflow:auto;
    font-size:13px;
}
</style>
</head>

<body>

<header>
üåø Flood Environmental Monitoring Station
<br>
<span id="connectionStatus">ƒêang k·∫øt n·ªëi...</span>
</header>

<div class="container">

<!-- LEFT PANEL -->
<div class="card">
    <h3>Th√¥ng s·ªë</h3>
    <div>ADC</div>
    <div class="big-number" id="adcValue">--</div>
    <div>M·ª±c n∆∞·ªõc (cm)</div>
    <div class="big-number" id="cmValue">--</div>
    <br>
    <div>Tr·∫°ng th√°i</div>
    <div id="statusBox" class="status safe">---</div>
</div>

<!-- CHART -->
<div class="card">
    <h3>Bi·ªÉu ƒë·ªì Realtime</h3>
    <canvas id="chart"></canvas>
</div>

<!-- RIVER -->
<div class="card">
    <h3>M√¥ ph·ªèng m·ª±c n∆∞·ªõc</h3>
    <div class="river-box">
        <div class="water" id="waterLevel" style="height:20%"></div>

        <!-- SCALE CHU·∫®N: 0 d∆∞·ªõi, 6 tr√™n -->
        <div class="scale">
            <span>6 cm</span>
            <span>5 cm</span>
            <span>4 cm</span>
            <span>3 cm</span>
            <span>2 cm</span>
            <span>1 cm</span>
            <span>0 cm</span>
        </div>
    </div>
</div>

</div>

<div class="card" style="margin:20px">
    <h3>Log tr·∫°ng th√°i</h3>
    <div class="log" id="logBox"></div>
</div>

<script>
const TOKEN = "aDr0xW5cnhpazhuPPuIDUQWZGmtRtAhY";

// Proxy tr√°nh CORS khi ch·∫°y GitHub Pages
function getBlynkValue(pin){
    const url = `https://blynk.cloud/external/api/get?token=${TOKEN}&${pin}`;
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    return fetch(proxy).then(res=>res.text());
}

const adcDisplay = document.getElementById("adcValue");
const cmDisplay = document.getElementById("cmValue");
const statusBox = document.getElementById("statusBox");
const water = document.getElementById("waterLevel");
const logBox = document.getElementById("logBox");
const connectionStatus = document.getElementById("connectionStatus");

let lastStatus = "";

/* ===== CHART ===== */
const ctx = document.getElementById("chart").getContext("2d");
const chart = new Chart(ctx,{
    type:"line",
    data:{
        labels:[],
        datasets:[{
            label:"ADC",
            data:[],
            tension:0.4
        }]
    },
    options:{
        responsive:true,
        scales:{
            y:{ beginAtZero:true }
        }
    }
});

/* ===== FUNCTIONS ===== */

function addLog(text){
    const time = new Date().toLocaleTimeString();
    logBox.innerHTML = `[${time}] ${text}<br>` + logBox.innerHTML;
}

function updateStatus(adc){
    let status="";
    let className="";

    if(adc < 1000){
        status="An to√†n";
        className="safe";
    }
    else if(adc < 1600){
        status="Nguy hi·ªÉm";
        className="warning";
    }
    else{
        status="R·∫•t nguy hi·ªÉm";
        className="danger";
    }

    statusBox.textContent=status;
    statusBox.className="status "+className;

    if(status !== lastStatus){
        addLog("Chuy·ªÉn sang: " + status);
        lastStatus = status;
    }
}

function updateChart(adc){
    if(chart.data.labels.length > 30){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }

    chart.data.labels.push("");
    chart.data.datasets[0].data.push(adc);
    chart.update();
}

function updateWater(adc){
    let percent = 20 + (adc/2000)*40;
    let cm = (percent/100)*6;

    water.style.height = percent + "%";

    adcDisplay.textContent = adc;
    cmDisplay.textContent = cm.toFixed(2);
}

function fetchData(){
    Promise.all([
        getBlynkValue("V0"),
        getBlynkValue("V1")
    ])
    .then(([adcRaw,statusString])=>{
        connectionStatus.textContent="ƒê√£ k·∫øt n·ªëi";

        const adc = parseInt(adcRaw);

        updateWater(adc);
        updateStatus(adc);
        updateChart(adc);
    })
    .catch(()=>{
        connectionStatus.textContent="M·∫•t k·∫øt n·ªëi";
    });
}

/* Auto c·∫≠p nh·∫≠t 2 gi√¢y */
setInterval(fetchData,2000);
fetchData();

</script>

</body>
</html>